d_pep = {
    'GLY':'G','ALA':'A','VAL':'V','LEU':'L','ILE':'I','SER':'S','THR':'T','CYS':'C','MET':'M','ASP':'D','GLU':'E','ASN':'N','GLN':'Q','HIS':'H','LYS':'K','ARG':'R','PRO':'P','PHE':'F','TRP':'W','TYR':'Y',
    'UNK':'X','ASX':'X','GLX':'X',
    'MSE':'M', ## ligand in 2e1a
    }

l_nuc = [
     'A', 'C', 'G', 'U',      'I', ## ribonucleotides
    'DA','DC','DG',     'DT','DI', ## deoxyribonucleotides
    'N', ## N is any 5'-monophosphate nucleotide
    ]

s_alphabet = ' ABCDEFGHIJKLMNOPQRSTUVWXYZ'

def check_if_SEQRESres(res_name,record,d_header,chain,res_no,iCode):

    if res_name not in d_pep.keys()+l_nuc and record == 'ATOM':
        print res_name,record
        stop

    if res_name in d_pep.keys()+l_nuc and record in ['ATOM','REMARK465',]:
        return True

    MODRES = False
    if 'MODRES' in d_header.keys():
        if chain in d_header['MODRES'].keys():
            if res_no in d_header['MODRES'][chain].keys():
                if iCode in d_header['MODRES'][chain][res_no].keys():
                    if res_name in d_header['MODRES'][chain][res_no][iCode]:
                        MODRES = True
                    else:
                        print chain, res_no,iCode
                        print res_name,d_header['MODRES'][chain][res_no][iCode]
                        stop

    return MODRES


def append_sequence(record,res_no,iCode,altloc,res_name_ATOM,d_ATOMseq,chain,d_header,l_REMARK465_res_nos,append_REMARK465,append_ATOM):

    if append_REMARK465 == True:
        for res_no_REMARK465 in l_REMARK465_res_nos:
            if res_no_REMARK465 in d_header['REMARK465']['chains'][chain]['residues'].keys():
                l_iCodes_REMARK465 = d_header['REMARK465']['chains'][chain]['residues'][res_no_REMARK465]['l_iCodes']
                for iCode_REMARK465 in l_iCodes_REMARK465:
                    res_name_REMARK465 = d_header['REMARK465']['chains'][chain]['residues'][res_no_REMARK465]['d_iCodes'][iCode_REMARK465]['res_name']
                    d_ATOMseq[chain]['seq'] += [res_name_REMARK465]
                    d_ATOMseq[chain]['res_nos'] += [res_no_REMARK465]
                    d_ATOMseq[chain]['iCodes'] += [iCode_REMARK465]
                    d_ATOMseq[chain]['altlocs'] += [' ']
                    d_ATOMseq[chain]['records'] += ['REMARK465']
                del d_header['REMARK465']['chains'][chain]['residues'][res_no_REMARK465]
##            else: ## not 3b95
##                break

    if append_ATOM == True:
        d_ATOMseq[chain]['seq'] += [res_name_ATOM]
        d_ATOMseq[chain]['res_nos'] += [res_no]
        d_ATOMseq[chain]['iCodes'] += [iCode]
        d_ATOMseq[chain]['altlocs'] += [altloc]
        d_ATOMseq[chain]['records'] += [record]

    return d_ATOMseq, d_header


def parse_header(lines):

    d_header = {}

    for i in range(len(lines)):
        line = lines[i]

        record = line[:6].strip()

        if record == 'EXPDTA': ## section 2
            methods = line[10:].strip().split(',')[0]
            if methods[:3] == 'NMR':
                methods = 'NMR'
            elif 'X-RAY' in methods or methods == 'FIBER DIFFRACTION' or methods == 'POWDER DIFFRACTION': ## e.g. (synchrotron) x-ray (fiber, powder) diffraction
                methods = 'X-RAY'
            d_header['EXPDTA'] = methods

        elif record == 'REMARK': ## section 2
            d_header = parse_recordREMARK(d_header, line, i, lines)

        elif record == 'SEQRES': ## section 3
            d_header = parse_recordSEQRES(line, d_header)

        elif record == 'MODRES': ## section 3
            parse_recordMODRES(line, d_header,)

        elif record == 'HET': ## section 4
            d_header = parse_recordHET(line, d_header,)

        elif record == 'HELIX':
            d_header = parse_recordHELIX(line,d_header,)

    return d_header


def parse_recordSHEET(line, d_header,):

    sheet_ID = line[11:14].strip()
    sheet_no = int(line[7:10])

    chain1 = line[21]
    res_no1 = int(line[22:26])
    iCode1 = line[26]
    chain2 = line[32]
    res_no2 = int(line[33:37])
    iCode2 = line[37]

    if chain1 != chain2:
        print line
        stop

    if 'SHEET' not in d_header.keys():
        d_header['SHEET'] = {}
    if chain1 not in d_header['SHEET'].keys():
        d_header['SHEET'][chain1] = {}
    if not '%4i%1s' %(res_no1,iCode1) in d_header['SHEET'][chain1].keys():
        d_header['SHEET'][chain1]['%4i%1s' %(res_no1,iCode1)] = {'res_no':res_no2,'iCode':iCode2,}

    return d_header


def parse_recordHELIX(line, d_header,):

    chain1 = line[19]
    res_no1 = int(line[21:25])
    iCode1 = line[25]
    chain2 = line[31]
    res_no2 = int(line[33:37])
    iCode2 = line[37]
    helix_len = int(line[71:76])
    helix_no = int(line[7:10])

    if 'HELIX' not in d_header.keys():
        d_header['HELIX'] = {}
    if chain1 not in d_header['HELIX'].keys():
        d_header['HELIX'][chain1] = {}
    if not '%4i%1s' %(res_no1,iCode1) in d_header['HELIX'][chain1].keys():
        d_header['HELIX'][chain1]['%4i%1s' %(res_no1,iCode1)] = helix_len

    return d_header


def parse_coordinates(lines, d_header,):

    d_atomnos = {}
    d_coordinates = {}
    d_ATOMseq = {}

    for i in range(len(lines)):
        line = lines[i]
        record = line[:6].strip()

        if record == 'ATOM':
            d_coordinates, d_line, d_ATOMseq = parse_recordATOM(line, d_coordinates, lines, i, d_header, 'ATOM', d_ATOMseq)
            d_atomnos[d_line['atom_no']] = d_line

        elif record == 'HETATM':
            res_name = line[17:20].strip()
            chain = line[21]
            ## water
            if res_name in ['D2O','H2O',]:
                print pdb, res_name
                stop
            elif res_name in ['HOH','DOD',]: ## DOD e.g. 2d4i
                continue
            ## modified residue of polypeptide or polynucleotide
            elif res_name == 'MSE' and 'MSE' in d_header['SEQRES']['chains'][chain]['seq3']: ## e.g. 1gcj,2e1a
                d_coordinates, d_line, d_ATOMseq = parse_recordATOM(line, d_coordinates, lines, i, d_header, 'ATOM', d_ATOMseq)
            ## (poly)saccharide or other hetero compound
            else:
                d_coordinates, d_line, d_ATOMseq = parse_recordATOM(line, d_coordinates, lines, i, d_header, 'HETATM', d_ATOMseq)
            atom_no = d_line['atom_no']
            d_atomnos[atom_no] = d_line

        elif record == 'MODEL':
            model = int(line.split()[1])

        elif record == 'ENDMDL':
            break

    return d_coordinates, d_ATOMseq


def parse_recordHET(line, d_header,):

    hetID = line[7:10].strip()
    ## continue if water
    if hetID in ['HOH','DOD',]:
        return d_header
    if hetID in ['D2O','DOD','H2O',]:
        print hetID
        stop
    chain = line[12]
    res_no = int(line[13:17])
    iCode = line[17]
    if 'HET' not in d_header.keys():
        d_header['HET'] = {}
    if chain not in d_header['HET'].keys():
        d_header['HET'][chain] = {}
    if res_no not in d_header['HET'][chain].keys():
        d_header['HET'][chain][res_no] = {}
    if iCode not in d_header['HET'][chain][res_no].keys():
        d_header['HET'][chain][res_no][iCode] = [hetID]
    elif hetID not in d_header['HET'][chain][res_no][iCode]:
        d_header['HET'][chain][res_no][iCode] += [hetID]

    return d_header

def parse_recordMODRES(line, d_header,):

    hetID = line[12:15].strip()
    chain = line[16]
    res_no = int(line[18:22])
    iCode = line[22]
    res_name = line[24:27].strip()
    txt = line[29:80].strip()

    ## return if e.g. glycosylation site (e.g. 3c43)
    if hetID in set(d_pep.keys())-set(['MSE']) and res_name in set(d_pep.keys())-set(['MSE']):
        return d_header

    if 'MODRES' not in d_header.keys():
        d_header['MODRES'] = {}
    if chain not in d_header['MODRES'].keys():
        d_header['MODRES'][chain] = {}
    if res_no not in d_header['MODRES'][chain].keys():
        d_header['MODRES'][chain][res_no] = {}
    if iCode not in d_header['MODRES'][chain][res_no].keys():
        d_header['MODRES'][chain][res_no][iCode] = [hetID]
    elif hetID not in d_header['MODRES'][chain][res_no][iCode]:
        d_header['MODRES'][chain][res_no][iCode] += [hetID]

    return d_header


def parse_recordREMARK(d_header, line, i, lines):

    remark = int(line[6:10])

    if remark == 2:
        if (
            line[11:38] == 'RESOLUTION. NOT APPLICABLE.'
            or
            line[11:38] == 'RESOLUTION. NULL ANGSTROMS.'
            ):
            d_header['REMARK2'] = 'N/A'
            return d_header
        try:
            resolution = float(line[22:27])
            d_header['REMARK2'] = resolution
        except:
            pass

    elif remark == 465: ## missing residues

        d_header = parse_recordREMARK465(line, lines, i, d_header)

    elif remark == 470: ## missing atoms

        d_header = parse_recordREMARK470(line, lines, i, d_header)

    return d_header


def parse_recordREMARK465(line, lines, i, d_header):

    ## missing residues

    if line[10:].strip() in [
        'M RES C SSSEQI',
        'M RES C  SSEQI',
        ]:

        for j in range(i+1,len(lines)):

            if lines[j][:10] != 'REMARK 465':
                break

            try:
                model = int(lines[j][12:14])
            except:
                model = 1
            res_name = lines[j][15:18].strip()
            chain = lines[j][19]
            res_no = int(lines[j][22:26])
            iCode = lines[j][26]

            if model != 1: ## e.g. 1ohh
                return d_header

            if not 'REMARK465' in d_header.keys():
                d_header['REMARK465'] = {}
            if not 'chains' in d_header['REMARK465'].keys():
                d_header['REMARK465']['chains'] = {}
            if not chain in d_header['REMARK465']['chains'].keys():
                d_header['REMARK465']['chains'][chain] = {}
            if not 'residues' in d_header['REMARK465']['chains'][chain].keys():
                d_header['REMARK465']['chains'][chain]['residues'] = {}
            if not res_no in d_header['REMARK465']['chains'][chain]['residues'].keys():
                d_header['REMARK465']['chains'][chain]['residues'][res_no] = {}

            ## res_no > d_iCodes
            if not 'd_iCodes' in d_header['REMARK465']['chains'][chain]['residues'][res_no].keys():
                d_header['REMARK465']['chains'][chain]['residues'][res_no]['d_iCodes'] = {}
            ## d_iCodes > iCode
            if not iCode in d_header['REMARK465']['chains'][chain]['residues'][res_no]['d_iCodes']:
                d_header['REMARK465']['chains'][chain]['residues'][res_no]['d_iCodes'][iCode] = {}

            ## iCode > record
            d_header['REMARK465']['chains'][chain]['residues'][res_no]['d_iCodes'][iCode]['record'] = 'REMARK465'

            ## iCode > res_name
            d_header['REMARK465']['chains'][chain]['residues'][res_no]['d_iCodes'][iCode]['res_name'] = res_name

            ## res_no > l_iCodes
            if not 'l_iCodes' in d_header['REMARK465']['chains'][chain]['residues'][res_no].keys():
                d_header['REMARK465']['chains'][chain]['residues'][res_no]['l_iCodes'] = []
            ## l_iCodes > iCode
            if not iCode in d_header['REMARK465']['chains'][chain]['residues'][res_no]['l_iCodes']:
                d_header['REMARK465']['chains'][chain]['residues'][res_no]['l_iCodes'] += [iCode]

            ## iCode > REMARK
            if not 'REMARK' in d_header['REMARK465']['chains'][chain]['residues'][res_no]['d_iCodes'][iCode].keys():
                d_header['REMARK465']['chains'][chain]['residues'][res_no]['d_iCodes'][iCode]['REMARK'] = True

            ## iCode > record
            d_header['REMARK465']['chains'][chain]['residues'][res_no]['d_iCodes'][iCode]['record'] = 'REMARK465'


    return d_header


def parse_recordREMARK470(line, lines, i, d_header):

    ## missing atoms

    ## the latter equation is only to acommodate for 1fvk.pdb
    if line[10:].strip() == 'M RES CSSEQI  ATOMS' or line[10:].strip() == 'M RES C SEQI  ATOMS':

        for j in range(i+1,len(lines)):

            if lines[j][:10] != 'REMARK 470':
                break

            ## model M
            try:
                model = int(lines[j][11:13])
            except:
                model = 'N/A'

            ## res_name RES
            res_name = lines[j][15:18].strip()

            ## chain C
            chain = lines[j][19]

            ## res_no SSEQ
            try:
                res_no = int(lines[j][20:24])
            except:
                res_no = lines[j][20:24].strip()

            ## iCode I
            iCode = lines[j][24]

            ## atoms ATOMS
            atoms = lines[j][25:].split()

            ##
            ## write to dictionary
            ##
            if not 'REMARK470' in d_header.keys():
                d_header['REMARK470'] = {}
            if not 'chains' in d_header['REMARK470'].keys():
                d_header['REMARK470']['chains'] = {}
            if not chain in d_header['REMARK470']['chains'].keys():
                d_header['REMARK470']['chains'][chain] = {}
            if not 'residues' in d_header['REMARK470']['chains'][chain].keys():
                d_header['REMARK470']['chains'][chain]['residues'] = {}
            if not res_no in d_header['REMARK470']['chains'][chain]['residues'].keys():
                d_header['REMARK470']['chains'][chain]['residues'][res_no] = {}

            ## res_no > l_iCodes
            if not 'l_iCodes' in d_header['REMARK470']['chains'][chain]['residues'][res_no].keys():
                d_header['REMARK470']['chains'][chain]['residues'][res_no]['l_iCodes'] = []
            ## l_iCodes > iCode
            if not iCode in d_header['REMARK470']['chains'][chain]['residues'][res_no]['l_iCodes']:
                d_header['REMARK470']['chains'][chain]['residues'][res_no]['l_iCodes'] += [iCode]

            ## res_no > d_iCodes
            if not 'd_iCodes' in d_header['REMARK470']['chains'][chain]['residues'][res_no].keys():
                d_header['REMARK470']['chains'][chain]['residues'][res_no]['d_iCodes'] = {}
            ## d_iCodes > iCode
            if not iCode in d_header['REMARK470']['chains'][chain]['residues'][res_no]['d_iCodes']:
                d_header['REMARK470']['chains'][chain]['residues'][res_no]['d_iCodes'][iCode] = {}

            ## iCode > atoms
            if not 'atoms' in d_header['REMARK470']['chains'][chain]['residues'][res_no]['d_iCodes'][iCode].keys():
                d_header['REMARK470']['chains'][chain]['residues'][res_no]['d_iCodes'][iCode]['atoms'] = {}
            ## atoms > atom_name > coordinate
            for atom_name in atoms:
                if not atom_name in d_header['REMARK470']['chains'][chain]['residues'][res_no]['d_iCodes'][iCode]['atoms'].keys():
                    d_header['REMARK470']['chains'][chain]['residues'][res_no]['d_iCodes'][iCode]['atoms'][atom_name] = {}
                ## iCode > REMARK
                d_header['REMARK470']['chains'][chain]['residues'][res_no]['d_iCodes'][iCode]['atoms'][atom_name]['REMARK'] = True

            ## iCode > res_name
            if not 'res_name' in d_header['REMARK470']['chains'][chain]['residues'][res_no]['d_iCodes'][iCode].keys():
                d_header['REMARK470']['chains'][chain]['residues'][res_no]['d_iCodes'][iCode]['res_name'] = res_name


    elif line[10:].strip().split() == ['M','RES','CSSEQI','ATOMS']:
        print pdb1
        print pdb2
        notexpected

    return d_header


def parse_recordSEQRES(line, d_header):

    chain = line[11]

    if 'SEQRES' not in d_header.keys():
        d_header['SEQRES'] = {}
    if 'chains' not in d_header['SEQRES'].keys():
        d_header['SEQRES']['chains'] = {}
    if chain not in d_header['SEQRES']['chains'].keys():
        d_header['SEQRES']['chains'][chain] = {}
    if not 'type' in d_header['SEQRES']['chains'][chain].keys():
        d_header['SEQRES']['chains'][chain]['type'] = 'N/A'

    l_residues = line[19:70].split()

    s_residues = ''
    for i in range(len(l_residues)):
        residue = l_residues[i]
        if residue in d_pep.keys():
            if d_header['SEQRES']['chains'][chain]['type'] == 'N/A':
                d_header['SEQRES']['chains'][chain]['type'] = 'peptide'
            s_residues += d_pep[residue]
        elif residue in l_nuc:
            if d_header['SEQRES']['chains'][chain]['type'] == 'N/A':
                d_header['SEQRES']['chains'][chain]['type'] = 'nucleotide'
            s_residues += residue
        elif residue in ['GLC','GAL','MAN','FRU']:
            if d_header['SEQRES']['chains'][chain]['type'] == 'N/A':
                d_header['SEQRES']['chains'][chain]['type'] = 'saccharide'
            s_residues += residue
        else:
            if residue == 'UNK': ## e.g. 1pny.pdb
                if d_header['SEQRES']['chains'][chain]['type'] == 'N/A':
                    d_header['SEQRES']['chains'][chain]['type'] = 'peptide'
            s_residues += 'X'

    if 'seq' not in d_header['SEQRES']['chains'][chain].keys():
        d_header['SEQRES']['chains'][chain]['seq'] = ''
    d_header['SEQRES']['chains'][chain]['seq'] += s_residues

    if 'seq3' not in d_header['SEQRES']['chains'][chain].keys():
        d_header['SEQRES']['chains'][chain]['seq3'] = []
    d_header['SEQRES']['chains'][chain]['seq3'] += l_residues

    return d_header


def parse_recordATOM(line, d_coordinates, lines, i, d_header, record, d_ATOMseq,):

    import Numeric

    atom_no = int(line[6:11])
    atom_name = line[12:16].strip()
    altloc = line[16]
    res_name_ATOM = line[17:20].strip()
    chain = line[21]
    res_no = int(line[22:26])
    iCode = line[26]
    x = float(line[30:38])
    y = float(line[38:46])
    z = float(line[46:54])
    element = line[76:78].strip()
    coordinate = Numeric.array([x, y, z])

    skip = False

    ## modified residue?
    SEQRESres = check_if_SEQRESres(res_name_ATOM,record,d_header,chain,res_no,iCode,)
    if SEQRESres == False:
        skip = True

    if chain in d_header['SEQRES']['chains']:
        type = d_header['SEQRES']['chains'][chain]['type']
        if type != 'peptide':
            skip = True
    else:
        skip = True

    if skip == True:
        return d_coordinates, {
            'chain':chain,
            'res_name':res_name_ATOM,'res_no':res_no,'iCode':iCode,'altloc':altloc,
            'atom_no':atom_no,'atom_name':atom_name,'element':element,
            }, d_ATOMseq

    if not 'chains' in d_coordinates.keys():
        d_coordinates['chains'] = {}
    if not chain in d_coordinates['chains'].keys():
        d_coordinates['chains'][chain] = {}
    if not 'residues' in d_coordinates['chains'][chain].keys():
        d_coordinates['chains'][chain]['residues'] = {}

    ## res_no
    if not res_no in d_coordinates['chains'][chain]['residues'].keys():
        d_coordinates['chains'][chain]['residues'][res_no] = {}

    ## res_no > d_iCodes
    if not 'd_iCodes' in d_coordinates['chains'][chain]['residues'][res_no].keys():
        d_coordinates['chains'][chain]['residues'][res_no]['d_iCodes'] = {}
    ## d_iCodes > iCode
    if not iCode in d_coordinates['chains'][chain]['residues'][res_no]['d_iCodes']:
        d_coordinates['chains'][chain]['residues'][res_no]['d_iCodes'][iCode] = {}


    if not chain in d_ATOMseq.keys():
        d_ATOMseq[chain] = {
            'seq':[],'iCodes':[],'res_nos':[],'altlocs':[],'records':[],
            }

    if lines[i-1][:6].strip() in ['ATOM','HETATM','ANISOU','SIGUIJ','SIGATM',]:
        res_no_prev = int(lines[i-1][22:26])
        iCode_prev = lines[i-1][26]
        altloc_prev = lines[i-1][16]
    else:
        res_no_prev = None
        iCode_prev = None
        altloc_prev = None

    ## 2zfo (atlloc B in SEQRES)
    skip = False
    if chain in d_ATOMseq.keys():
        if len(d_ATOMseq[chain]['seq']) > 0:
            if (
                d_ATOMseq[chain]['res_nos'][-1] == res_no and
                d_ATOMseq[chain]['iCodes'][-1] == iCode
                ):
                ## skip if altloc A not added
                skip = True

    if (
        (
            len(d_ATOMseq[chain]['seq']) == 0 or
            (
                not (
                    res_no == res_no_prev and
                    iCode == iCode_prev and
                    altloc == altloc_prev ## 2zfo (atlloc B in SEQRES)
                    )
                )
            ) and
        skip == False
        ):


        res_name_REMARK465 = None
        REMARK465_before_ATOM = False
        if 'REMARK465' in d_header.keys():
            if chain in d_header['REMARK465']['chains'].keys():

                pass_if = False

                if res_no_prev != None:
                    ## REMARK465 before ATOM (gap between REMARK465 and next ATOM but not prev ATOM)
                    ## 2nv7
                    if res_no_prev+1 in d_header['REMARK465']['chains'][chain]['residues'].keys():
                        pass_if = True
                    ## REMARK465 before ATOM (gap between REMARK465 and next ATOM and prev ATOM)
                    ## 2pqj (not 2qqh)
                    if set(range(res_no_prev+1,res_no)) & set(d_header['REMARK465']['chains'][chain]['residues'].keys()):
                        pass_if = True

                if len(d_header['REMARK465']['chains'][chain]['residues'].keys()) > 0:
                    ## REMARK465 before or after ATOM
                    if res_no in d_header['REMARK465']['chains'][chain]['residues'].keys():
                        pass_if = True
                    ## REMARK465 before ATOM
                    if res_no-1 in d_header['REMARK465']['chains'][chain]['residues'].keys():
                        pass_if = True
                    ## REMARK465 before ATOM (no zero residue)
                    ## 1b9n,2fxm
                    if res_no_prev == None and res_no >= 1 and -1 in d_header['REMARK465']['chains'][chain]['residues'].keys():
                        pass_if = True
                    ## REMARK465 before ATOM (first residue = 0 and second residue > 1) ## e.g 2asd,1ca5
                    if res_no_prev == None and res_no > 1 and 0 in d_header['REMARK465']['chains'][chain]['residues'].keys():
                        pass_if = True
                    ## REMARK465 before ATOM (first residue > 1 and second residue > 1) ## e.g 2h27
                    if res_no_prev == None and res_no > 1 and res_no > min(d_header['REMARK465']['chains'][chain]['residues'].keys()):
                        pass_if = True
                    ## REMARK465 before ATOM
                    ## 1sgf,1nu0
                    if res_no_prev == min(d_header['REMARK465']['chains'][chain]['residues'].keys()):
                        pass_if = True

                if pass_if == True:

                    ## REMARK465 before ATOM?
                    ## e.g. 3bef
                    if min(d_header['REMARK465']['chains'][chain]['residues'].keys()) <= res_no:
                        if res_no in d_header['REMARK465']['chains'][chain]['residues'].keys():

                            l_iCodes_REMARK465 = d_header['REMARK465']['chains'][chain]['residues'][res_no]['l_iCodes']
                            index1 = s_alphabet.index(min(l_iCodes_REMARK465))
                            index2 = s_alphabet.index(max(l_iCodes_REMARK465))+1
                            l_iCodes_ascending = ','.join(s_alphabet[index1:index2]).split(',')
                            l_iCodes_descending = list(l_iCodes_ascending)
                            l_iCodes_descending.reverse()
                            if l_iCodes_REMARK465 == l_iCodes_ascending:
                                ascending = True
                                descending = False
                            elif l_iCodes_REMARK465 == l_iCodes_descending:
                                ascending = False
                                descending = True

                            if len(l_iCodes_REMARK465) > 1 and iCode == ' ' and ascending == True:
                                l_REMARK465_res_nos = range(min(d_header['REMARK465']['chains'][chain]['residues'].keys()),res_no) ## e.g. 1b8m
                            elif len(l_iCodes_REMARK465) > 1 and iCode == ' ' and descending == True:
                                l_REMARK465_res_nos = range(min(d_header['REMARK465']['chains'][chain]['residues'].keys()),res_no+1) ## e.g. 2ass
                            elif iCode != ' ':
                                l_REMARK465_res_nos = range(min(d_header['REMARK465']['chains'][chain]['residues'].keys()),res_no+1) ## e.g. 3bef
                            ## e.g. 2bvs
                            elif len(l_iCodes_REMARK465) == 1:
                                l_REMARK465_res_nos = range(min(d_header['REMARK465']['chains'][chain]['residues'].keys()),res_no+1)
                                l_REMARK465_res_names = []
                                for res_no_REMARK465 in l_REMARK465_res_nos:
                                    if res_no_REMARK465 in d_header['REMARK465']['chains'][chain]['residues'].keys():
                                        l_iCodes_REMARK465 = d_header['REMARK465']['chains'][chain]['residues'][res_no_REMARK465]['l_iCodes']
                                        for iCode_REMARK465 in l_iCodes_REMARK465:
                                            res_name_REMARK465 = d_header['REMARK465']['chains'][chain]['residues'][res_no_REMARK465]['d_iCodes'][iCode_REMARK465]['res_name']
                                            l_REMARK465_res_names += [res_name_REMARK465]
                                iCode_REMARK465 = l_iCodes_REMARK465[0]
                                res_name_REMARK465 = d_header['REMARK465']['chains'][chain]['residues'][res_no]['d_iCodes'][iCode_REMARK465]['res_name']
                                SEQRES_seq = d_header['SEQRES']['chains'][chain]['seq3'][:len(l_REMARK465_res_names)]
                                if SEQRES_seq == l_REMARK465_res_names:
                                    pass
                                else:
                                    l_REMARK465_res_nos = range(min(d_header['REMARK465']['chains'][chain]['residues'].keys()),res_no)
                            else:
                                stop
                        else:
                            l_REMARK465_res_nos = range(min(d_header['REMARK465']['chains'][chain]['residues'].keys()),res_no)

                        ## e.g. 1bd7
                        l_REMARK465_res_names = []
                        for res_no_REMARK465 in l_REMARK465_res_nos:
                            if res_no_REMARK465 in d_header['REMARK465']['chains'][chain]['residues'].keys():
                                l_iCodes_REMARK465 = d_header['REMARK465']['chains'][chain]['residues'][res_no_REMARK465]['l_iCodes']
                                for iCode_REMARK465 in l_iCodes_REMARK465:
                                    res_name_REMARK465 = d_header['REMARK465']['chains'][chain]['residues'][res_no_REMARK465]['d_iCodes'][iCode_REMARK465]['res_name']
                                    l_REMARK465_res_names += [res_name_REMARK465]
##                            else: ## not 3b95
##                                break

                        if len(l_REMARK465_res_names) > 0:
                            l_SEQRES_res_names = d_header['SEQRES']['chains'][chain]['seq3'][len(d_ATOMseq[chain]['seq']):][:len(l_REMARK465_res_names)]
                            ## multiple residue insertion
                            ## 4htc
                            if len(l_REMARK465_res_names) > 1 and l_REMARK465_res_names == l_SEQRES_res_names:
                                REMARK465_before_ATOM = True
                            ## single residue insertion
                            elif (
                                len(l_REMARK465_res_names) == 1 and
                                l_REMARK465_res_names[0] == l_SEQRES_res_names[0] and
                                res_name_ATOM != l_SEQRES_res_names[0]
                                ):
                                REMARK465_before_ATOM = True
                            ## single residue insertion, res_no_465 < res_no_ATOM
                            ## 2hu9
                            elif (
                                len(l_REMARK465_res_names) == 1 and
                                l_REMARK465_res_names[0] == l_SEQRES_res_names[0] and
                                res_name_ATOM == l_SEQRES_res_names[0] and
                                res_no > min(l_REMARK465_res_nos)
                                ):
                                REMARK465_before_ATOM = True
                            ## REMARK465 not before ATOM
                            ## e.g. 3bef,1bd7,4htc
                            else:
                                REMARK465_before_ATOM = False
                        ## REMARK465 not before ATOM
                        ## e.g. 2a0q
                        else:
                            REMARK465_before_ATOM = False

                    if not REMARK465_before_ATOM == True: ## e.g. 103l
                        if res_no in d_header['REMARK465']['chains'][chain]['residues'].keys():
                            res_no_REMARK465 = res_no
                            l_iCodes_REMARK465 = d_header['REMARK465']['chains'][chain]['residues'][res_no_REMARK465]['l_iCodes']
                            iCode_REMARK465 = l_iCodes_REMARK465[0]
                            res_name_REMARK465 = d_header['REMARK465']['chains'][chain]['residues'][res_no_REMARK465]['d_iCodes'][iCode_REMARK465]['res_name']

        try:
            res_name_SEQRES = d_header['SEQRES']['chains'][chain]['seq3'][len(d_ATOMseq[chain]['seq'])]
        except:
            res_name_SEQRES = 'N/A'

        if REMARK465_before_ATOM == False and res_name_ATOM != res_name_SEQRES and res_name_ATOM in ['FOR','HOA','ACE',] and (res_no == min(d_coordinates['chains'][chain]['residues'].keys()) or res_no == max(d_coordinates['chains'][chain]['residues'].keys())):
            fd = open('formyl.txt','a')
            fd.write('%s %s %s\n' %(pdb, chain, res_name_ATOM))
            fd.close()
            return d_coordinates, {
                'chain':chain,
                'res_name':res_name_ATOM,'res_no':res_no,'iCode':iCode,'altloc':altloc,
                'atom_no':atom_no,'atom_name':atom_name,'element':element,
                }, d_ATOMseq

        ## REMARK465 after ATOM
        if REMARK465_before_ATOM == False and res_name_ATOM == res_name_SEQRES:# and res_name_REMARK465 != res_name_SEQRES:
            d_ATOMseq,d_header = append_sequence(record,res_no,iCode,altloc,res_name_ATOM,d_ATOMseq,chain,d_header,None,False,True,)
        ## REMARK465 before ATOM (certain)
        elif REMARK465_before_ATOM == True:# and res_name_ATOM != res_name_SEQRES:# and res_name_REMARK465 == res_name_SEQRES:
            d_ATOMseq,d_header = append_sequence(record,res_no,iCode,altloc,res_name_ATOM,d_ATOMseq,chain,d_header,l_REMARK465_res_nos,True,True,)
        else:
            try:
                print '---'
                SEQRES_res_name = d_header['SEQRES']['chains'][chain]['seq3'][len(d_ATOMseq[chain]['seq'])]
                SEQRES_seq = d_header['SEQRES']['chains'][chain]['seq3'][:len(d_ATOMseq[chain]['seq'])]
                print chain, res_no, iCode
                print line
                print d_ATOMseq[chain]['seq']
                print d_header['SEQRES']['chains'][chain]['seq3']
                print 'altloc', altloc
                if 'REMARK465' not in d_header.keys() and atom_name == 'CA' and d_coordinates['chains'][chain]['residues'][res_no]['d_iCodes'][iCode] == {}:
                    stop_remark470_records_missing
                    pass
                elif 'REMARK465' not in d_header.keys() and atom_name == 'N' and res_no == 2 and res_name_SEQRES == 'MET':
                    stop_remark465_records_missing_met1
                    pass
                ## 2zfo
                elif 'REMARK465' not in d_header.keys() and altloc != ' ':
                    if res_name_SEQRES == res_name_ATOM:
                        stop
                    pass
                elif 'REMARK465' not in d_header.keys() and altloc == ' ':
                    pass ## new, temp
                elif res_name_REMARK465 == None and chain in d_header['REMARK465']['chains'].keys() and min(d_header['REMARK465']['chains'][chain]['residues'].keys()) < res_no: ## e.g. 3c5w
                    print chain,res_no
                    print d_header['REMARK465']['chains'][chain]['residues'].keys()
                    stop_temp_broken
                    pass
                ## REMARK465 after ATOM
                elif (
                    (iCode == ' ' or len(d_ATOMseq[chain]['seq']) == 0) and
                    res_no <= min(d_header['REMARK465']['chains'][chain]['residues'].keys()) and
                    res_name_ATOM == SEQRES_res_name
                    ):
                    stop_temp_example_commentout
                    d_ATOMseq[chain]['seq'] += [res_name_ATOM]
                    d_ATOMseq[chain]['res_nos'] += [res_no]
                    d_ATOMseq[chain]['iCodes'] += [iCode]
                    d_ATOMseq[chain]['records'] += [record]
                else:
                    ## 1jly
                    if res_name_ATOM in ['FOR','HOA','ACE',] and (res_no == min(d_coordinates['chains'][chain]['residues'].keys()) or res_no == max(d_coordinates['chains'][chain]['residues'].keys())):
                        fd = open('formyl.txt','a')
                        fd.write('%s %s %s\n' %(pdb, chain, res_name_ATOM))
                        fd.close()
                        return d_coordinates, {
                            'chain':chain,
                            'res_name':res_name_ATOM,'res_no':res_no,'iCode':iCode,'altloc':altloc,
                            'atom_no':atom_no,'atom_name':atom_name,'element':element,
                            }, d_ATOMseq
                    print '*******'
                    print 'ATOM  ', d_ATOMseq[chain]['seq']
                    print 'SEQRES', SEQRES_seq
                    print line
                    print chain,res_no
                    print 'SEQRES', SEQRES_res_name
                    print 'ATOM  ', res_name_ATOM, '***iCode***', iCode
                    print 'REMARK', res_name_REMARK465, iCode_REMARK465
                    stop_N_terminal
            except:
                pass
                

        if d_ATOMseq[chain]['seq'] != d_header['SEQRES']['chains'][chain]['seq3'][:len(d_ATOMseq[chain]['seq'])]:
            print '*******'
            print 'ATOM  ', d_ATOMseq[chain]['seq']
            print 'SEQRES', d_header['SEQRES']['chains'][chain]['seq3'][:len(d_ATOMseq[chain]['seq'])]
            print res_name_ATOM
            print line
            print res_name_REMARK465
            print pdb, chain, res_no, iCode
            stop_sequence_difference

    ## iCode > record
    d_coordinates['chains'][chain]['residues'][res_no]['d_iCodes'][iCode]['record'] = record

    ## iCode > seq_no
    d_coordinates['chains'][chain]['residues'][res_no]['d_iCodes'][iCode]['seq_no'] = len(d_ATOMseq[chain]['seq'])-1

    ## iCode > res_name
    if not 'res_name' in d_coordinates['chains'][chain]['residues'][res_no]['d_iCodes'][iCode].keys():
        d_coordinates['chains'][chain]['residues'][res_no]['d_iCodes'][iCode]['res_name'] = res_name_ATOM
    ## check that res_name is correct (e.g. 2fes:L:1)
    elif d_coordinates['chains'][chain]['residues'][res_no]['d_iCodes'][iCode]['res_name'] != res_name_ATOM and altloc == ' ': ## 1fh2:A:30 altloc
        print d_coordinates['chains'][chain]['residues'][res_no]['d_iCodes'][iCode]['res_name']
        print res_name_ATOM
        print altloc
        print chain, res_no, iCode
        print line
        stop_add_altloc

    ## res_no > l_iCodes
    if not 'l_iCodes' in d_coordinates['chains'][chain]['residues'][res_no].keys():
        d_coordinates['chains'][chain]['residues'][res_no]['l_iCodes'] = []
    ## l_iCodes > iCode
    if not iCode in d_coordinates['chains'][chain]['residues'][res_no]['l_iCodes']:
        d_coordinates['chains'][chain]['residues'][res_no]['l_iCodes'] += [iCode]

    ## iCode > atoms
    if not 'atoms' in d_coordinates['chains'][chain]['residues'][res_no]['d_iCodes'][iCode].keys():
        d_coordinates['chains'][chain]['residues'][res_no]['d_iCodes'][iCode]['atoms'] = {}
    ## atoms > atom_name > coordinate
    if not atom_name in d_coordinates['chains'][chain]['residues'][res_no]['d_iCodes'][iCode]['atoms'].keys():
        d_coordinates['chains'][chain]['residues'][res_no]['d_iCodes'][iCode]['atoms'][atom_name] = {'coordinate':coordinate}

    ## iCode > record
    if not 'record' in d_coordinates['chains'][chain]['residues'][res_no]['d_iCodes'][iCode].keys():
        d_coordinates['chains'][chain]['residues'][res_no]['d_iCodes'][iCode]['record'] = record

  
    return d_coordinates, {
        'chain':chain,
        'res_name':res_name_ATOM,'res_no':res_no,'iCode':iCode,'altloc':altloc,
        'atom_no':atom_no,'atom_name':atom_name,'element':element,
        }, d_ATOMseq
